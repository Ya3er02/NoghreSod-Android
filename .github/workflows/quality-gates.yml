name: Quality Gates

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest --stacktrace
      
      - name: Generate Coverage Report
        run: ./gradlew jacocoTestDebugUnitTestReport
      
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./app/build/reports/jacoco/jacocoTestDebugUnitTestReport/jacocoTestDebugUnitTestReport.xml
          flags: unittests
          fail_ci_if_error: true

  instrumentation-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        api-level: [ 30, 31, 32, 33, 34 ]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Run Instrumentation Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: x86_64
          script: ./gradlew connectedAndroidTest

  lint-and-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Run Android Lint
        run: ./gradlew lint
      
      - name: Run Detekt
        run: ./gradlew detekt
      
      - name: Upload Lint Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: app/build/reports/lint-results*.html
      
      - name: Upload Detekt Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detekt-results
          path: app/build/reports/detekt.html

  security:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Run OWASP Dependency Check
        run: ./gradlew dependencyCheckAnalyze
        continue-on-error: false
      
      - name: Verify ProGuard Configuration
        run: ./gradlew assembleRelease --stacktrace
      
      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: app/build/reports/dependency-check/

  build:
    runs-on: ubuntu-latest
    needs: [ unit-tests, lint-and-analysis ]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Build Debug APK
        run: ./gradlew assembleDebug
      
      - name: Build Release APK
        run: ./gradlew assembleRelease
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apks
          path: app/build/outputs/apk/

  quality-gate:
    runs-on: ubuntu-latest
    needs: [ unit-tests, instrumentation-tests, lint-and-analysis, security ]
    
    steps:
      - name: Download Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: coverage
      
      - name: Check Quality Gate
        run: |
          echo "✅ All quality gates passed!"
          echo "✓ Unit tests passed"
          echo "✓ Instrumentation tests passed"
          echo "✓ Lint analysis passed"
          echo "✓ Security checks passed"
